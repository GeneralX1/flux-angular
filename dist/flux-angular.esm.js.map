{"version":3,"file":"flux-angular.esm.js","sources":["../src/flux-angular.js"],"sourcesContent":["import Baobab from 'baobab'\nimport dispatchr from 'dispatchr'\nimport angular from 'angular'\n\nconst angularModule = angular.module\nlet registeredStores = []\nlet autoInjectStores = false\nlet useEvalAsync = true\n\n// A function that creates stores\nfunction createStore(name, spec = {}, immutableDefaults, flux) {\n  // Constructor of a yahoo dispatchr store\n  const Store = function(dispatcher) {\n    this.dispatcher = dispatcher\n\n    // Check if store exists when waiting for it\n    this.waitFor = function(stores, cb) {\n      stores = Array.isArray(stores) ? stores : [stores]\n      if (!flux.areStoresRegistered(stores)) {\n        throw new Error(\n          'Waiting for stores that are not injected into Angular yet, ' +\n            stores.join(', ') +\n            '. Be sure to inject stores before waiting for them'\n        )\n      }\n      this.dispatcher.waitFor(stores, cb.bind(this))\n    }\n\n    if (!this.initialize) {\n      throw new Error(\n        'Store ' +\n          name +\n          ' does not have an initialize method which is is necessary to set the initial state'\n      )\n    }\n\n    this.initialize()\n  }\n\n  // Add constructor properties, as required by Yahoo Dispatchr\n  Store.handlers = spec.handlers\n  Store.storeName = name\n\n  // Instantiates immutable state and saves it to private variable that can be used for setting listeners\n  Store.prototype.immutable = function(initialState, options = {}) {\n    if (this.__tree) {\n      this.__tree.set(initialState)\n    } else {\n      this.__tree = new Baobab(\n        initialState,\n        angular.extend({}, immutableDefaults, options)\n      )\n    }\n    return this.__tree\n  }\n\n  Store.prototype.monkey = Baobab.monkey\n\n  // Attach store definition to the prototype\n  Object.keys(spec).forEach(function(key) {\n    Store.prototype[key] = spec[key]\n  })\n\n  return Store\n}\n\n// Flux Service is a wrapper for the Yahoo Dispatchr\nconst FluxService = function(immutableDefaults) {\n  this.stores = []\n  this.dispatcherInstance = dispatchr.createDispatcher()\n  this.dispatcher = this.dispatcherInstance.createContext()\n\n  this.dispatch = function() {\n    if (registeredStores.length) {\n      console.warn(\n        'There are still stores not injected: ' +\n          registeredStores.join(',') +\n          '. Make sure to manually inject all stores before running any dispatches or set autoInjectStores to true.'\n      ) // eslint-disable-line no-console\n    }\n    this.dispatcher.dispatch.apply(this.dispatcher, arguments)\n  }\n\n  this.createStore = function(name, spec) {\n    const store = createStore(name, spec, immutableDefaults, this)\n    let storeInstance\n\n    // Create the exports object\n    store.exports = {}\n\n    this.dispatcherInstance.registerStore(store)\n    this.stores.push(store)\n\n    // Add cloning to exports\n\n    if (!spec.exports) {\n      throw new Error(\n        'You have to add an exports object to your store: ' + name\n      )\n    }\n\n    storeInstance = this.dispatcher.getStore(store)\n    Object.keys(spec.exports).forEach(function(key) {\n      // Create a getter\n      const descriptor = Object.getOwnPropertyDescriptor(spec.exports, key)\n      if (descriptor.get) {\n        Object.defineProperty(store.exports, key, {\n          enumerable: descriptor.enumerable,\n          configurable: descriptor.configurable,\n          get: () => descriptor.get.apply(storeInstance),\n        })\n      } else {\n        store.exports[key] = function() {\n          return spec.exports[key].apply(storeInstance, arguments)\n        }\n        spec.exports[key] = spec.exports[key].bind(storeInstance)\n      }\n    })\n\n    return store.exports\n  }\n\n  this.getStore = function(storeExport) {\n    const store = this.stores.filter(s => s.exports === storeExport)[0]\n    return this.dispatcher.getStore(store)\n  }\n\n  this.areStoresRegistered = function(stores) {\n    const storeNames = this.stores.map(store => store.storeName)\n    return stores.every(storeName => storeNames.indexOf(storeName) > -1)\n  }\n\n  this.reset = function() {\n    this.dispatcherInstance.stores = {}\n    this.dispatcherInstance.handlers = {}\n    this.stores = []\n    registeredStores = []\n  }\n\n  // Expose Baobab in case user wants access to it for use outside a store\n  this.Baobab = Baobab\n}\n\n// Wrap \"angular.module\" to attach store method to module instance\nangular.module = function() {\n  // Call the module as normaly and grab the instance\n  const moduleInstance = angularModule.apply(angular, arguments)\n\n  // Attach store method to instance\n  moduleInstance.store = function(storeName, storeDefinition) {\n    // Add to stores array\n    registeredStores.push(storeName)\n\n    // Create a new store\n    this.factory(storeName, [\n      '$injector',\n      'flux',\n      function($injector, flux) {\n        const storeConfig = $injector.invoke(storeDefinition)\n        registeredStores.splice(registeredStores.indexOf(storeName), 1)\n        return flux.createStore(storeName, storeConfig)\n      },\n    ])\n\n    return this\n  }\n\n  return moduleInstance\n}\n\nangular\n  .module('flux', [])\n  .provider('flux', function FluxProvider() {\n    let immutableDefaults = {}\n\n    // Defaults that are passed on to Baobab: https://github.com/Yomguithereal/baobab#options\n    this.setImmutableDefaults = function(defaults) {\n      immutableDefaults = defaults\n    }\n\n    this.autoInjectStores = function(val) {\n      autoInjectStores = val\n    }\n\n    this.useEvalAsync = function(val) {\n      useEvalAsync = val\n    }\n\n    this.$get = [\n      function fluxFactory() {\n        return new FluxService(immutableDefaults)\n      },\n    ]\n  })\n  .run([\n    '$rootScope',\n    '$injector',\n    'flux',\n    function($rootScope, $injector, flux) {\n      if (angular.mock) {\n        // Forced to false during testing to avoid needing to flush to test $listenTo interaction\n        useEvalAsync = false\n        flux.reset()\n      }\n\n      if (!angular.mock && autoInjectStores) {\n        $injector.invoke(registeredStores.concat(angular.noop))\n      }\n\n      // Extend scopes with $listenTo\n      $rootScope.constructor.prototype.$listenTo = function(\n        storeExport,\n        mapping,\n        callback\n      ) {\n        let cursor, originalCallback\n        const store = flux.getStore(storeExport)\n\n        if (!store.__tree) {\n          throw new Error(\n            'Store ' +\n              storeExport.storeName +\n              ' has not defined state with this.immutable() which is required in order to use $listenTo'\n          )\n        }\n\n        if (!callback) {\n          callback = mapping\n          cursor = store.__tree\n        } else {\n          cursor = store.__tree.select(mapping)\n        }\n\n        originalCallback = callback\n        if (useEvalAsync) {\n          callback = e => {\n            this.$evalAsync(() => originalCallback(e))\n          }\n        }\n\n        cursor.on('update', callback)\n\n        // Call the callback so that state gets the initial sync with the view-model variables. evalAsync is specifically\n        // not used here because state should be available to angular as it is initializing. Otherwise state can be\n        // undefined while the first digest cycle is running.\n        originalCallback({})\n\n        // Remove the listeners on the store when scope is destroyed (GC)\n        this.$on('$destroy', () => cursor.off('update', callback))\n      }\n    },\n  ])\n\nexport default 'flux'\n"],"names":["angularModule","angular","module","registeredStores","autoInjectStores","useEvalAsync","createStore","name","spec","immutableDefaults","flux","Store","dispatcher","waitFor","stores","cb","Array","isArray","areStoresRegistered","Error","join","bind","initialize","handlers","storeName","prototype","immutable","initialState","options","__tree","set","Baobab","extend","monkey","Object","keys","forEach","key","FluxService","dispatcherInstance","dispatchr","createDispatcher","createContext","dispatch","length","console","warn","apply","arguments","store","storeInstance","exports","registerStore","push","getStore","descriptor","getOwnPropertyDescriptor","get","defineProperty","enumerable","configurable","storeExport","filter","s","storeNames","map","every","indexOf","reset","moduleInstance","storeDefinition","factory","$injector","storeConfig","invoke","splice","provider","FluxProvider","setImmutableDefaults","defaults","val","$get","fluxFactory","run","$rootScope","mock","concat","noop","constructor","$listenTo","mapping","callback","cursor","originalCallback","select","e","$evalAsync","on","$on","off"],"mappings":";;;;AAIA,IAAMA,aAAa,GAAGC,OAAO,CAACC,MAA9B;AACA,IAAIC,gBAAgB,GAAG,EAAvB;AACA,IAAIC,gBAAgB,GAAG,KAAvB;AACA,IAAIC,YAAY,GAAG,IAAnB;;AAGA,SAASC,WAAT,CAAqBC,IAArB,EAA2BC,IAA3B,EAAsCC,iBAAtC,EAAyDC,IAAzD,EAA+D;MAApCF,IAAoC;IAApCA,IAAoC,GAA7B,EAA6B;;;;MAEvDG,KAAK,GAAG,SAARA,KAAQ,CAASC,UAAT,EAAqB;SAC5BA,UAAL,GAAkBA,UAAlB,CADiC;;SAI5BC,OAAL,GAAe,UAASC,MAAT,EAAiBC,EAAjB,EAAqB;MAClCD,MAAM,GAAGE,KAAK,CAACC,OAAN,CAAcH,MAAd,IAAwBA,MAAxB,GAAiC,CAACA,MAAD,CAA1C;;UACI,CAACJ,IAAI,CAACQ,mBAAL,CAAyBJ,MAAzB,CAAL,EAAuC;cAC/B,IAAIK,KAAJ,CACJ,gEACEL,MAAM,CAACM,IAAP,CAAY,IAAZ,CADF,GAEE,oDAHE,CAAN;;;WAMGR,UAAL,CAAgBC,OAAhB,CAAwBC,MAAxB,EAAgCC,EAAE,CAACM,IAAH,CAAQ,IAAR,CAAhC;KATF;;QAYI,CAAC,KAAKC,UAAV,EAAsB;YACd,IAAIH,KAAJ,CACJ,WACEZ,IADF,GAEE,oFAHE,CAAN;;;SAOGe,UAAL;GAxBF,CAF6D;;;EA8B7DX,KAAK,CAACY,QAAN,GAAiBf,IAAI,CAACe,QAAtB;EACAZ,KAAK,CAACa,SAAN,GAAkBjB,IAAlB,CA/B6D;;EAkC7DI,KAAK,CAACc,SAAN,CAAgBC,SAAhB,GAA4B,UAASC,YAAT,EAAuBC,OAAvB,EAAqC;QAAdA,OAAc;MAAdA,OAAc,GAAJ,EAAI;;;QAC3D,KAAKC,MAAT,EAAiB;WACVA,MAAL,CAAYC,GAAZ,CAAgBH,YAAhB;KADF,MAEO;WACAE,MAAL,GAAc,IAAIE,MAAJ,CACZJ,YADY,EAEZ1B,OAAO,CAAC+B,MAAR,CAAe,EAAf,EAAmBvB,iBAAnB,EAAsCmB,OAAtC,CAFY,CAAd;;;WAKK,KAAKC,MAAZ;GATF;;EAYAlB,KAAK,CAACc,SAAN,CAAgBQ,MAAhB,GAAyBF,MAAM,CAACE,MAAhC,CA9C6D;;EAiD7DC,MAAM,CAACC,IAAP,CAAY3B,IAAZ,EAAkB4B,OAAlB,CAA0B,UAASC,GAAT,EAAc;IACtC1B,KAAK,CAACc,SAAN,CAAgBY,GAAhB,IAAuB7B,IAAI,CAAC6B,GAAD,CAA3B;GADF;SAIO1B,KAAP;;;;AAIF,IAAM2B,WAAW,GAAG,SAAdA,WAAc,CAAS7B,iBAAT,EAA4B;OACzCK,MAAL,GAAc,EAAd;OACKyB,kBAAL,GAA0BC,SAAS,CAACC,gBAAV,EAA1B;OACK7B,UAAL,GAAkB,KAAK2B,kBAAL,CAAwBG,aAAxB,EAAlB;;OAEKC,QAAL,GAAgB,YAAW;QACrBxC,gBAAgB,CAACyC,MAArB,EAA6B;MAC3BC,OAAO,CAACC,IAAR,CACE,0CACE3C,gBAAgB,CAACiB,IAAjB,CAAsB,GAAtB,CADF,GAEE,0GAHJ,EAD2B;;;SAOxBR,UAAL,CAAgB+B,QAAhB,CAAyBI,KAAzB,CAA+B,KAAKnC,UAApC,EAAgDoC,SAAhD;GARF;;OAWK1C,WAAL,GAAmB,UAASC,IAAT,EAAeC,IAAf,EAAqB;QAChCyC,KAAK,GAAG3C,WAAW,CAACC,IAAD,EAAOC,IAAP,EAAaC,iBAAb,EAAgC,IAAhC,CAAzB;QACIyC,aAAJ,CAFsC;;IAKtCD,KAAK,CAACE,OAAN,GAAgB,EAAhB;SAEKZ,kBAAL,CAAwBa,aAAxB,CAAsCH,KAAtC;SACKnC,MAAL,CAAYuC,IAAZ,CAAiBJ,KAAjB,EARsC;;QAYlC,CAACzC,IAAI,CAAC2C,OAAV,EAAmB;YACX,IAAIhC,KAAJ,CACJ,sDAAsDZ,IADlD,CAAN;;;IAKF2C,aAAa,GAAG,KAAKtC,UAAL,CAAgB0C,QAAhB,CAAyBL,KAAzB,CAAhB;IACAf,MAAM,CAACC,IAAP,CAAY3B,IAAI,CAAC2C,OAAjB,EAA0Bf,OAA1B,CAAkC,UAASC,GAAT,EAAc;;UAExCkB,UAAU,GAAGrB,MAAM,CAACsB,wBAAP,CAAgChD,IAAI,CAAC2C,OAArC,EAA8Cd,GAA9C,CAAnB;;UACIkB,UAAU,CAACE,GAAf,EAAoB;QAClBvB,MAAM,CAACwB,cAAP,CAAsBT,KAAK,CAACE,OAA5B,EAAqCd,GAArC,EAA0C;UACxCsB,UAAU,EAAEJ,UAAU,CAACI,UADiB;UAExCC,YAAY,EAAEL,UAAU,CAACK,YAFe;UAGxCH,GAAG,EAAE;mBAAMF,UAAU,CAACE,GAAX,CAAeV,KAAf,CAAqBG,aAArB,CAAN;;SAHP;OADF,MAMO;QACLD,KAAK,CAACE,OAAN,CAAcd,GAAd,IAAqB,YAAW;iBACvB7B,IAAI,CAAC2C,OAAL,CAAad,GAAb,EAAkBU,KAAlB,CAAwBG,aAAxB,EAAuCF,SAAvC,CAAP;SADF;;QAGAxC,IAAI,CAAC2C,OAAL,CAAad,GAAb,IAAoB7B,IAAI,CAAC2C,OAAL,CAAad,GAAb,EAAkBhB,IAAlB,CAAuB6B,aAAvB,CAApB;;KAbJ;WAiBOD,KAAK,CAACE,OAAb;GApCF;;OAuCKG,QAAL,GAAgB,UAASO,WAAT,EAAsB;QAC9BZ,KAAK,GAAG,KAAKnC,MAAL,CAAYgD,MAAZ,CAAmB,UAAAC,CAAC;aAAIA,CAAC,CAACZ,OAAF,KAAcU,WAAlB;KAApB,EAAmD,CAAnD,CAAd;WACO,KAAKjD,UAAL,CAAgB0C,QAAhB,CAAyBL,KAAzB,CAAP;GAFF;;OAKK/B,mBAAL,GAA2B,UAASJ,MAAT,EAAiB;QACpCkD,UAAU,GAAG,KAAKlD,MAAL,CAAYmD,GAAZ,CAAgB,UAAAhB,KAAK;aAAIA,KAAK,CAACzB,SAAV;KAArB,CAAnB;WACOV,MAAM,CAACoD,KAAP,CAAa,UAAA1C,SAAS;aAAIwC,UAAU,CAACG,OAAX,CAAmB3C,SAAnB,IAAgC,CAAC,CAArC;KAAtB,CAAP;GAFF;;OAKK4C,KAAL,GAAa,YAAW;SACjB7B,kBAAL,CAAwBzB,MAAxB,GAAiC,EAAjC;SACKyB,kBAAL,CAAwBhB,QAAxB,GAAmC,EAAnC;SACKT,MAAL,GAAc,EAAd;IACAX,gBAAgB,GAAG,EAAnB;GAJF,CAjE8C;;;OAyEzC4B,MAAL,GAAcA,MAAd;CAzEF;;;AA6EA9B,OAAO,CAACC,MAAR,GAAiB,YAAW;;MAEpBmE,cAAc,GAAGrE,aAAa,CAAC+C,KAAd,CAAoB9C,OAApB,EAA6B+C,SAA7B,CAAvB,CAF0B;;EAK1BqB,cAAc,CAACpB,KAAf,GAAuB,UAASzB,SAAT,EAAoB8C,eAApB,EAAqC;;IAE1DnE,gBAAgB,CAACkD,IAAjB,CAAsB7B,SAAtB,EAF0D;;SAKrD+C,OAAL,CAAa/C,SAAb,EAAwB,CACtB,WADsB,EAEtB,MAFsB,EAGtB,UAASgD,SAAT,EAAoB9D,IAApB,EAA0B;UAClB+D,WAAW,GAAGD,SAAS,CAACE,MAAV,CAAiBJ,eAAjB,CAApB;MACAnE,gBAAgB,CAACwE,MAAjB,CAAwBxE,gBAAgB,CAACgE,OAAjB,CAAyB3C,SAAzB,CAAxB,EAA6D,CAA7D;aACOd,IAAI,CAACJ,WAAL,CAAiBkB,SAAjB,EAA4BiD,WAA5B,CAAP;KANoB,CAAxB;WAUO,IAAP;GAfF;;SAkBOJ,cAAP;CAvBF;;AA0BApE,OAAO,CACJC,MADH,CACU,MADV,EACkB,EADlB,EAEG0E,QAFH,CAEY,MAFZ,EAEoB,SAASC,YAAT,GAAwB;MACpCpE,iBAAiB,GAAG,EAAxB,CADwC;;OAInCqE,oBAAL,GAA4B,UAASC,QAAT,EAAmB;IAC7CtE,iBAAiB,GAAGsE,QAApB;GADF;;OAIK3E,gBAAL,GAAwB,UAAS4E,GAAT,EAAc;IACpC5E,gBAAgB,GAAG4E,GAAnB;GADF;;OAIK3E,YAAL,GAAoB,UAAS2E,GAAT,EAAc;IAChC3E,YAAY,GAAG2E,GAAf;GADF;;OAIKC,IAAL,GAAY,CACV,SAASC,WAAT,GAAuB;WACd,IAAI5C,WAAJ,CAAgB7B,iBAAhB,CAAP;GAFQ,CAAZ;CAlBJ,EAwBG0E,GAxBH,CAwBO,CACH,YADG,EAEH,WAFG,EAGH,MAHG,EAIH,UAASC,UAAT,EAAqBZ,SAArB,EAAgC9D,IAAhC,EAAsC;MAChCT,OAAO,CAACoF,IAAZ,EAAkB;;IAEhBhF,YAAY,GAAG,KAAf;IACAK,IAAI,CAAC0D,KAAL;;;MAGE,CAACnE,OAAO,CAACoF,IAAT,IAAiBjF,gBAArB,EAAuC;IACrCoE,SAAS,CAACE,MAAV,CAAiBvE,gBAAgB,CAACmF,MAAjB,CAAwBrF,OAAO,CAACsF,IAAhC,CAAjB;GARkC;;;EAYpCH,UAAU,CAACI,WAAX,CAAuB/D,SAAvB,CAAiCgE,SAAjC,GAA6C,UAC3C5B,WAD2C,EAE3C6B,OAF2C,EAG3CC,QAH2C,EAI3C;;;QACIC,MAAJ,EAAYC,gBAAZ;QACM5C,KAAK,GAAGvC,IAAI,CAAC4C,QAAL,CAAcO,WAAd,CAAd;;QAEI,CAACZ,KAAK,CAACpB,MAAX,EAAmB;YACX,IAAIV,KAAJ,CACJ,WACE0C,WAAW,CAACrC,SADd,GAEE,0FAHE,CAAN;;;QAOE,CAACmE,QAAL,EAAe;MACbA,QAAQ,GAAGD,OAAX;MACAE,MAAM,GAAG3C,KAAK,CAACpB,MAAf;KAFF,MAGO;MACL+D,MAAM,GAAG3C,KAAK,CAACpB,MAAN,CAAaiE,MAAb,CAAoBJ,OAApB,CAAT;;;IAGFG,gBAAgB,GAAGF,QAAnB;;QACItF,YAAJ,EAAkB;MAChBsF,QAAQ,GAAG,kBAAAI,CAAC,EAAI;QACd,KAAI,CAACC,UAAL,CAAgB;iBAAMH,gBAAgB,CAACE,CAAD,CAAtB;SAAhB;OADF;;;IAKFH,MAAM,CAACK,EAAP,CAAU,QAAV,EAAoBN,QAApB,EA1BA;;;;IA+BAE,gBAAgB,CAAC,EAAD,CAAhB,CA/BA;;SAkCKK,GAAL,CAAS,UAAT,EAAqB;aAAMN,MAAM,CAACO,GAAP,CAAW,QAAX,EAAqBR,QAArB,CAAN;KAArB;GAtCF;CAhBC,CAxBP;AAmFA,kBAAe,MAAf;;;;"}