{"version":3,"file":"flux-angular.cjs.js","sources":["../src/flux-angular.js"],"sourcesContent":["import Baobab from 'baobab'\nimport dispatchr from 'dispatchr'\nimport angular from 'angular'\n\nconst angularModule = angular.module\nlet registeredStores = []\nlet autoInjectStores = false\nlet useEvalAsync = true\n\nconst map = new Map()\nmap.set(angular, true)\n\n// A function that creates stores\nfunction createStore(name, spec = {}, immutableDefaults, flux) {\n  // Constructor of a yahoo dispatchr store\n  const Store = function(dispatcher) {\n    this.dispatcher = dispatcher\n\n    // Check if store exists when waiting for it\n    this.waitFor = function(stores, cb) {\n      stores = Array.isArray(stores) ? stores : [stores]\n      if (!flux.areStoresRegistered(stores)) {\n        throw new Error(\n          'Waiting for stores that are not injected into Angular yet, ' +\n            stores.join(', ') +\n            '. Be sure to inject stores before waiting for them'\n        )\n      }\n      this.dispatcher.waitFor(stores, cb.bind(this))\n    }\n\n    if (!this.initialize) {\n      throw new Error(\n        'Store ' +\n          name +\n          ' does not have an initialize method which is is necessary to set the initial state'\n      )\n    }\n\n    this.initialize()\n  }\n\n  // Add constructor properties, as required by Yahoo Dispatchr\n  Store.handlers = spec.handlers\n  Store.storeName = name\n\n  // Instantiates immutable state and saves it to private variable that can be used for setting listeners\n  Store.prototype.immutable = function(initialState, options = {}) {\n    if (this.__tree) {\n      this.__tree.set(initialState)\n    } else {\n      this.__tree = new Baobab(\n        initialState,\n        angular.extend({}, immutableDefaults, options)\n      )\n    }\n    return this.__tree\n  }\n\n  Store.prototype.monkey = Baobab.monkey\n\n  // Attach store definition to the prototype\n  Object.keys(spec).forEach(function(key) {\n    Store.prototype[key] = spec[key]\n  })\n\n  return Store\n}\n\n// Flux Service is a wrapper for the Yahoo Dispatchr\nconst FluxService = function(immutableDefaults) {\n  this.stores = []\n  this.dispatcherInstance = dispatchr.createDispatcher()\n  this.dispatcher = this.dispatcherInstance.createContext()\n\n  this.dispatch = function() {\n    if (registeredStores.length) {\n      console.warn(\n        'There are still stores not injected: ' +\n          registeredStores.join(',') +\n          '. Make sure to manually inject all stores before running any dispatches or set autoInjectStores to true.'\n      ) // eslint-disable-line no-console\n    }\n    this.dispatcher.dispatch.apply(this.dispatcher, arguments)\n  }\n\n  this.createStore = function(name, spec) {\n    const store = createStore(name, spec, immutableDefaults, this)\n    let storeInstance\n\n    // Create the exports object\n    store.exports = {}\n\n    this.dispatcherInstance.registerStore(store)\n    this.stores.push(store)\n\n    // Add cloning to exports\n\n    if (!spec.exports) {\n      throw new Error(\n        'You have to add an exports object to your store: ' + name\n      )\n    }\n\n    storeInstance = this.dispatcher.getStore(store)\n    Object.keys(spec.exports).forEach(function(key) {\n      // Create a getter\n      const descriptor = Object.getOwnPropertyDescriptor(spec.exports, key)\n      if (descriptor.get) {\n        Object.defineProperty(store.exports, key, {\n          enumerable: descriptor.enumerable,\n          configurable: descriptor.configurable,\n          get: () => descriptor.get.apply(storeInstance),\n        })\n      } else {\n        store.exports[key] = function() {\n          return spec.exports[key].apply(storeInstance, arguments)\n        }\n        spec.exports[key] = spec.exports[key].bind(storeInstance)\n      }\n    })\n\n    return store.exports\n  }\n\n  this.getStore = function(storeExport) {\n    const store = this.stores.filter(s => s.exports === storeExport)[0]\n    return this.dispatcher.getStore(store)\n  }\n\n  this.areStoresRegistered = function(stores) {\n    const storeNames = this.stores.map(store => store.storeName)\n    return stores.every(storeName => storeNames.indexOf(storeName) > -1)\n  }\n\n  this.reset = function() {\n    this.dispatcherInstance.stores = {}\n    this.dispatcherInstance.handlers = {}\n    this.stores = []\n    registeredStores = []\n  }\n\n  // Expose Baobab in case user wants access to it for use outside a store\n  this.Baobab = Baobab\n}\n\n// Wrap \"angular.module\" to attach store method to module instance\nangular.module = function() {\n  // Call the module as normaly and grab the instance\n  const moduleInstance = angularModule.apply(angular, arguments)\n\n  // Attach store method to instance\n  moduleInstance.store = function(storeName, storeDefinition) {\n    // Add to stores array\n    registeredStores.push(storeName)\n\n    // Create a new store\n    this.factory(storeName, [\n      '$injector',\n      'flux',\n      function($injector, flux) {\n        const storeConfig = $injector.invoke(storeDefinition)\n        registeredStores.splice(registeredStores.indexOf(storeName), 1)\n        return flux.createStore(storeName, storeConfig)\n      },\n    ])\n\n    return this\n  }\n\n  return moduleInstance\n}\n\nangular\n  .module('flux', [])\n  .provider('flux', function FluxProvider() {\n    let immutableDefaults = {}\n\n    // Defaults that are passed on to Baobab: https://github.com/Yomguithereal/baobab#options\n    this.setImmutableDefaults = function(defaults) {\n      immutableDefaults = defaults\n    }\n\n    this.autoInjectStores = function(val) {\n      autoInjectStores = val\n    }\n\n    this.useEvalAsync = function(val) {\n      useEvalAsync = val\n    }\n\n    this.$get = [\n      function fluxFactory() {\n        return new FluxService(immutableDefaults)\n      },\n    ]\n  })\n  .run([\n    '$rootScope',\n    '$injector',\n    'flux',\n    function($rootScope, $injector, flux) {\n      if (angular.mock) {\n        // Forced to false during testing to avoid needing to flush to test $listenTo interaction\n        useEvalAsync = false\n        flux.reset()\n      }\n\n      if (!angular.mock && autoInjectStores) {\n        $injector.invoke(registeredStores.concat(angular.noop))\n      }\n\n      // Extend scopes with $listenTo\n      $rootScope.constructor.prototype.$listenTo = function(\n        storeExport,\n        mapping,\n        callback\n      ) {\n        let cursor, originalCallback\n        const store = flux.getStore(storeExport)\n\n        if (!store.__tree) {\n          throw new Error(\n            'Store ' +\n              storeExport.storeName +\n              ' has not defined state with this.immutable() which is required in order to use $listenTo'\n          )\n        }\n\n        if (!callback) {\n          callback = mapping\n          cursor = store.__tree\n        } else {\n          cursor = store.__tree.select(mapping)\n        }\n\n        originalCallback = callback\n        if (useEvalAsync) {\n          callback = e => {\n            this.$evalAsync(() => originalCallback(e))\n          }\n        }\n\n        cursor.on('update', callback)\n\n        // Call the callback so that state gets the initial sync with the view-model variables. evalAsync is specifically\n        // not used here because state should be available to angular as it is initializing. Otherwise state can be\n        // undefined while the first digest cycle is running.\n        originalCallback({})\n\n        // Remove the listeners on the store when scope is destroyed (GC)\n        this.$on('$destroy', () => cursor.off('update', callback))\n      }\n    },\n  ])\n\nmodule.exports = 'flux'\n"],"names":["angularModule","angular","module","registeredStores","autoInjectStores","useEvalAsync","map","Map","set","createStore","name","spec","immutableDefaults","flux","Store","dispatcher","waitFor","stores","cb","Array","isArray","areStoresRegistered","Error","join","bind","initialize","handlers","storeName","prototype","immutable","initialState","options","__tree","Baobab","extend","monkey","Object","keys","forEach","key","FluxService","dispatcherInstance","dispatchr","createDispatcher","createContext","dispatch","length","console","warn","apply","arguments","store","storeInstance","exports","registerStore","push","getStore","descriptor","getOwnPropertyDescriptor","get","defineProperty","enumerable","configurable","storeExport","filter","s","storeNames","every","indexOf","reset","moduleInstance","storeDefinition","factory","$injector","storeConfig","invoke","splice","provider","FluxProvider","setImmutableDefaults","defaults","val","$get","fluxFactory","run","$rootScope","mock","concat","noop","constructor","$listenTo","mapping","callback","cursor","originalCallback","select","e","$evalAsync","on","$on","off"],"mappings":"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"}